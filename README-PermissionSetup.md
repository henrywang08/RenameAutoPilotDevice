# Azure Managed Identity Permission Setup Guide

## Current Status ‚úÖ
- **Managed Identity Found**: `sgAutomationAccount` (ID: 6853874c-d6d4-4c96-8a54-c7ce2a4bab82)
- **Microsoft Graph Found**: Successfully located Microsoft Graph Service Principal
- **Script Working**: The permission assignment script is functioning correctly

## Issue: Insufficient Privileges ‚ö†Ô∏è
The current user account doesn't have sufficient privileges to assign application permissions to the Managed Identity.

## Required Azure AD Roles üîê
To assign Graph API permissions to a Managed Identity, you need one of these roles:
- **Global Administrator** (recommended)
- **Privileged Role Administrator**
- **Application Administrator** (may work for some permissions)

## Solution Options üõ†Ô∏è

### Option 1: Use Azure Portal (Recommended)
1. Go to [Azure Portal](https://portal.azure.com)
2. Navigate to **Azure Active Directory** > **Enterprise applications**
3. Search for `sgAutomationAccount`
4. Click on your Managed Identity
5. Go to **Permissions**
6. Click **Add a permission**
7. Select **Microsoft Graph** > **Application permissions**
8. Add these permissions:
   - `DeviceManagementManagedDevices.Read.All`
   - `DeviceManagementManagedDevices.PrivilegedOperations.All`
   - `Device.ReadWrite.All`
   - `Group.Read.All`
   - `GroupMember.Read.All`
   - `User.Read.All`
9. Click **Grant admin consent** (requires Global Admin)

### Option 2: Ask Your Global Administrator
If you don't have Global Admin rights:
1. Send this document to your Global Administrator
2. Ask them to run the script: `.\Grant-PermissiontoAzureAAId.ps1`
3. Or ask them to manually assign permissions via Azure Portal (Option 1)

### Option 3: PowerShell with Global Admin Account
If you have access to a Global Admin account:
1. Run PowerShell as that admin user
2. Execute: `.\Grant-PermissiontoAzureAAId.ps1`

## Verification Steps ‚úîÔ∏è
After permissions are granted, verify by running:
```powershell
# Check assigned permissions
Connect-MgGraph -Scopes "Application.Read.All"
$managedIdentity = Get-MgServicePrincipal -Filter "displayName eq 'sgAutomationAccount'"
$assignments = Get-MgServicePrincipalAppRoleAssignment -ServicePrincipalId $managedIdentity.Id
$assignments | Select-Object ResourceDisplayName, AppRoleId
```

## Next Steps After Permission Setup üöÄ
1. ‚úÖ Permissions are granted to Managed Identity
2. ‚úÖ Run the Azure Automation version of the script: `Rename-AutoPilotDevice_Azure.ps1`
3. ‚úÖ Set up Azure Automation Variables (optional)
4. ‚úÖ Create and schedule the runbook in Azure Automation

## Managed Identity Details üìã
- **Name**: sgAutomationAccount
- **Object ID**: 6853874c-d6d4-4c96-8a54-c7ce2a4bab82
- **Type**: System-assigned Managed Identity
- **Status**: Found and accessible

## Troubleshooting üîç
If you continue to have issues:
1. Verify your account has the required Azure AD roles
2. Ensure you're connected to the correct tenant
3. Check if conditional access policies are blocking the operation
4. Try using the Azure Portal method instead of PowerShell

---
**Generated by**: AutoPilot Device Rename Setup Assistant  
**Date**: October 8, 2025